import 'package:intl/intl.dart';

/// --------- Nombre / monnaie (GNF) ---------

final NumberFormat _fmt = NumberFormat.decimalPattern('fr_FR');
final NumberFormat _compact = NumberFormat.compact(locale: 'fr_FR');

/// 1 234 567 GNF (retourne 'Ã©Â©Â¢â‚¬Å¡Â¬â€šÂ¬Â' si null)
String gnf(num? v) =>
    v == null ? 'Ã©Â©Â¢â‚¬Å¡Â¬â€šÂ¬Â' : '${_fmt.format(v)} GNF';

/// 1,2 M GNF (retourne 'Ã©Â©Â¢â‚¬Å¡Â¬â€šÂ¬Â' si null)
String gnfCompact(num? v) =>
    v == null ? 'Ã©Â©Â¢â‚¬Å¡Â¬â€šÂ¬Â' : '${_compact.format(v)} GNF';

/// --------- Dates ---------

/// yyyy-MM-dd (retourne 'Ã©Â©Â¢â‚¬Å¡Â¬â€šÂ¬Â' si null)
String dateYMD(DateTime? d) => d == null
    ? 'Ã©Â©Â¢â‚¬Å¡Â¬â€šÂ¬Â'
    : DateFormat('yyyy-MM-dd', 'fr_FR').format(d);

/// dd/MM/yyyy (retourne 'Ã©Â©Â¢â‚¬Å¡Â¬â€šÂ¬Â' si null)
String dateDMY(DateTime? d) => d == null
    ? 'Ã©Â©Â¢â‚¬Å¡Â¬â€šÂ¬Â'
    : DateFormat('dd/MM/yyyy', 'fr_FR').format(d);

/// Convertit une valeur BDD (String ISO, Date, DateTimeÃ©Â©Â¢â‚¬Å¡Â¬Â¦) en DateTime local.
/// Renvoie null si non parseable.
DateTime? parseDbDate(dynamic v) {
  if (v == null) return null;
  if (v is DateTime) return v.toLocal();
  if (v is String && v.isNotEmpty) {
    try {
      return DateTime.parse(v)
          .toLocal(); // gÃ©Â©Ã†â€™Â¨re '2025-09-30' ou ISO '2025-09-30T12:00:00Z'
    } catch (_) {}
  }
  return null;
}

/// Formatte une valeur BDD (String/DateTime) en yyyy-MM-dd.
String dateYMDfromDb(dynamic v) => dateYMD(parseDbDate(v));

/// Ã©Â©Â¢â‚¬Å¡Â¬Ã©â€¦â‚¬Å“il y a 5 min / 3 h / 2 j / 12/03/2024Ã©Â©Â¢â‚¬Å¡Â¬Â
String relativeTime(DateTime? d) {
  if (d == null) return 'Ã©Â©Â¢â‚¬Å¡Â¬â€šÂ¬Â';
  final diff = DateTime.now().difference(d);
  if (diff.inMinutes < 60) return 'il y a ${diff.inMinutes} min';
  if (diff.inHours < 24) return 'il y a ${diff.inHours} h';
  if (diff.inDays < 7) return 'il y a ${diff.inDays} j';
  return dateDMY(d);
}
