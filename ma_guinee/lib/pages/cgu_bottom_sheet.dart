import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:supabase_flutter/supabase_flutter.dart'; // pour la mise √† jour Supabase

class CGUBottomSheet extends StatefulWidget {
  const CGUBottomSheet({super.key});

  @override
  State<CGUBottomSheet> createState() => _CGUBottomSheetState();
}

class _CGUBottomSheetState extends State<CGUBottomSheet> {
  bool _isAccepted = false;

  void _onAccept() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool('cgu_accepted', true);

    final userId = Supabase.instance.client.auth.currentUser?.id;
    if (userId != null) {
      await Supabase.instance.client
          .from('utilisateurs')
          .update({'cgu_accepte': true}).eq('id', userId);
    }

    Navigator.pop(context);
  }

  void _showFullCGU() {
    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: const Text('Conditions G√©n√©rales d‚ÄôUtilisation ‚Äî Soneya'),
        content: const SingleChildScrollView(
          child: SelectableText(
            'üßæ CONDITIONS G√âN√âRALES D‚ÄôUTILISATION (CGU)\n\n'
            '1. Pr√©sentation de l‚Äôapplication\n\n'
            'L‚Äôapplication Soneya, √©dit√©e par Mohamed Camara, domicili√© √† Dubreka (Kal√©ma), R√©publique de Guin√©e, a pour objectif de proposer un ensemble de services num√©riques destin√©s √† faciliter la vie quotidienne des utilisateurs en Guin√©e.\n\n'
            'Ces services comprennent notamment :\n\n'
            'la publication et la consultation d‚Äôoffres d‚Äôemploi et de candidatures,\n\n'
            'la mise en relation pour des logements (vente, location, terrains),\n\n'
            'la recherche et la r√©servation de restaurants, h√¥tels, prestataires de services,\n\n'
            'la d√©couverte du tourisme et de la culture guin√©enne,\n\n'
            'la consultation d‚Äô√©v√©nements, billetterie et annonces locales,\n\n'
            'un syst√®me de messagerie, de notifications et de cartes interactives,\n\n'
            'ainsi que tout autre service que l‚Äô√©diteur pourra ajouter dans les versions futures.\n\n'
            'L‚Äôutilisation de l‚Äôapplication Soneya implique l‚Äôacceptation pleine et enti√®re des pr√©sentes Conditions G√©n√©rales d‚ÄôUtilisation.\n\n'
            '2. Objet\n\n'
            'Les pr√©sentes CGU ont pour objet de d√©finir les conditions d‚Äôacc√®s, de consultation et d‚Äôutilisation des services propos√©s sur Soneya, que ce soit via mobile, tablette ou web.\n\n'
            '3. Acc√®s √† l‚Äôapplication\n\n'
            'L‚Äôapplication Soneya est accessible gratuitement √† tout utilisateur disposant d‚Äôun acc√®s Internet et d‚Äôun appareil compatible.\n'
            'Certains services pourront √©voluer et devenir payants ou affichant de la publicit√© dans de futures versions, sans que cela ne remette en cause la validit√© des pr√©sentes CGU.\n\n'
            '4. Inscription et compte utilisateur\n\n'
            'L‚Äôacc√®s √† certaines fonctionnalit√©s (publication, candidature, messagerie, etc.) n√©cessite la cr√©ation d‚Äôun compte utilisateur.\n'
            'L‚Äôutilisateur s‚Äôengage √† fournir des informations exactes, compl√®tes et √† jour lors de son inscription.\n'
            'Il est seul responsable de la confidentialit√© de ses identifiants (adresse e-mail, mot de passe) et de l‚Äôactivit√© r√©alis√©e sous son compte.\n\n'
            '5. Services propos√©s\n\n'
            'Soneya offre un ensemble de services int√©gr√©s :\n\n'
            'Emploi : d√©p√¥t et consultation d‚Äôoffres, candidatures, enregistrement de CV, √©changes entre employeurs et candidats.\n\n'
            'Logement : publication et recherche de logements, terrains ou biens immobiliers √† travers la Guin√©e.\n\n'
            'Tourisme & Culture : mise en valeur des sites, monuments, √©v√©nements culturels et activit√©s locales.\n\n'
            'Restaurants & H√¥tels : guide interactif pour d√©couvrir les meilleurs √©tablissements.\n\n'
            'Prestataires & Annonces : vitrine num√©rique pour artisans, commer√ßants et ind√©pendants.\n\n'
            'Messagerie et Notifications : communication entre utilisateurs dans le respect des r√®gles de bonne conduite.\n\n'
            'Carte interactive : g√©olocalisation des services et offres √† proximit√©.\n\n'
            'L‚Äô√©diteur se r√©serve le droit d‚Äôajouter, de modifier ou de supprimer tout service sans pr√©avis.\n\n'
            '6. Obligations de l‚Äôutilisateur\n\n'
            'L‚Äôutilisateur s‚Äôengage √† :\n\n'
            'utiliser Soneya de mani√®re l√©gale, respectueuse et responsable ;\n\n'
            'ne pas publier de contenu offensant, diffamatoire, discriminatoire, ill√©gal ou contraire √† la morale ;\n\n'
            'ne pas usurper l‚Äôidentit√© d‚Äôautrui ;\n\n'
            'ne pas diffuser de fausses informations ou d‚Äôannonces trompeuses ;\n\n'
            'ne pas tenter d‚Äôacc√©der frauduleusement √† des donn√©es ou √† des serveurs.\n\n'
            'En cas de non-respect de ces r√®gles, Mohamed Camara se r√©serve le droit de suspendre ou supprimer le compte fautif sans pr√©avis.\n\n'
            '7. Responsabilit√©\n\n'
            'Soneya met tout en ≈ìuvre pour garantir la fiabilit√© et la s√©curit√© de ses services, mais ne saurait √™tre tenue responsable :\n\n'
            'des interruptions temporaires ou d√©finitives du service ;\n\n'
            'des pertes de donn√©es ou d‚Äôinformations publi√©es par les utilisateurs ;\n\n'
            'des contenus, annonces ou offres publi√©es par des tiers ;\n\n'
            'ni des dommages directs ou indirects r√©sultant de l‚Äôusage de l‚Äôapplication.\n\n'
            'Les utilisateurs restent responsables de leurs interactions et transactions r√©alis√©es via la plateforme.\n\n'
            '8. Donn√©es personnelles et confidentialit√©\n\n'
            'Soneya collecte et traite certaines donn√©es personnelles n√©cessaires au bon fonctionnement de ses services :\n\n'
            'informations d‚Äôinscription (nom, e-mail, t√©l√©phone, photo de profil, CV, etc.) ;\n\n'
            'donn√©es de localisation pour certaines fonctionnalit√©s (ex. : ‚Äúautour de moi‚Äù) ;\n\n'
            'contenus publi√©s (annonces, messages, images, etc.).\n\n'
            'Ces donn√©es sont h√©berg√©es de mani√®re s√©curis√©e (notamment via Supabase, bas√© dans l‚ÄôUnion Europ√©enne) et ne sont jamais revendues √† des tiers sans consentement.\n\n'
            'L‚Äôutilisateur peut √† tout moment demander la suppression de ses donn√©es via la page de contact de l‚Äôapplication.\n\n'
            '9. Publicit√© et partenariats\n\n'
            'Des publicit√©s ou contenus sponsoris√©s pourront √™tre int√©gr√©s dans les prochaines versions de l‚Äôapplication.\n'
            'Soneya s‚Äôengage √† les pr√©senter de mani√®re claire, sans nuire √† l‚Äôexp√©rience utilisateur.\n\n'
            '10. Propri√©t√© intellectuelle\n\n'
            'Tous les √©l√©ments de l‚Äôapplication (logo, design, textes, code, images, base de donn√©es, etc.) sont la propri√©t√© exclusive de Mohamed Camara.\n'
            'Toute reproduction, distribution ou utilisation non autoris√©e est strictement interdite.\n\n'
            'Les contenus publi√©s par les utilisateurs restent leur propri√©t√©, mais ceux-ci accordent √† Soneya une licence gratuite et non exclusive pour les afficher sur la plateforme.\n\n'
            '11. S√©curit√© et int√©grit√© du r√©seau\n\n'
            'Soneya met en place des mesures techniques et organisationnelles pour prot√©ger les donn√©es et pr√©venir les intrusions.\n'
            'Toute tentative de piratage, d‚Äôing√©nierie inverse ou de perturbation du service entra√Ænera des poursuites conform√©ment √† la loi guin√©enne.\n\n'
            '12. Mod√©ration et signalement\n\n'
            'Les utilisateurs peuvent signaler tout contenu inappropri√© via le bouton ‚ÄúSignaler‚Äù ou la page de contact.\n'
            'L‚Äô√©quipe de Soneya se r√©serve le droit de supprimer tout contenu non conforme ou de bloquer un utilisateur.\n\n'
            '13. √âvolution des CGU\n\n'
            'Les pr√©sentes CGU peuvent √™tre modifi√©es √† tout moment afin de s‚Äôadapter √† l‚Äô√©volution des services, de la l√©gislation ou de la politique interne.\n'
            'La version la plus r√©cente est disponible dans l‚Äôapplication et sur le site officiel de Soneya.\n\n'
            '14. Droit applicable et juridiction comp√©tente\n\n'
            'Les pr√©sentes CGU sont r√©gies par le droit guin√©en.\n'
            'En cas de litige, les tribunaux comp√©tents seront ceux de la R√©publique de Guin√©e, sauf disposition contraire.\n\n'
            '15. Contact\n\n'
            'Pour toute question, r√©clamation ou demande relative √† l‚Äôapplication ou aux donn√©es personnelles :\n\n'
            'Mohamed Camara\n'
            'üìç Dubreka (Kal√©ma), R√©publique de Guin√©e\n'
            'üìß soneya.signaler@gmail.com\n',
            style: TextStyle(fontSize: 15, height: 1.45),
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('Fermer'),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return DraggableScrollableSheet(
      initialChildSize: 0.5,
      maxChildSize: 0.9,
      expand: false,
      builder: (_, controller) => Container(
        padding: const EdgeInsets.all(20),
        decoration: const BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
        ),
        child: ListView(
          controller: controller,
          children: [
            const Text(
              "Conditions G√©n√©rales d'Utilisation",
              style: TextStyle(fontWeight: FontWeight.bold, fontSize: 18),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 20),
            const Text(
              "En utilisant l‚Äôapplication Soneya, vous vous engagez √† respecter nos conditions. "
              "Vous pouvez consulter l‚Äôint√©gralit√© des CGU en cliquant ci-dessous.",
              style: TextStyle(fontSize: 15),
            ),
            TextButton(
              onPressed: _showFullCGU,
              child: const Text("Lire les CGU compl√®tes"),
            ),
            const SizedBox(height: 10),
            SwitchListTile(
              title: const Text("J‚Äôai lu et j‚Äôaccepte les CGU"),
              value: _isAccepted,
              onChanged: (val) => setState(() => _isAccepted = val),
            ),
            const SizedBox(height: 10),
            ElevatedButton(
              onPressed: _isAccepted ? _onAccept : null,
              style: ElevatedButton.styleFrom(
                backgroundColor: _isAccepted ? const Color(0xFF113CFC) : Colors.grey,
              ),
              child: const Text("Continuer"),
            ),
          ],
        ),
      ),
    );
  }
}
